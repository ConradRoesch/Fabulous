<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=https://timothelariviere.com/Fabulous-new/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://timothelariviere.com/Fabulous-new/fonts/vendor/jost/jost-v4-latin-500.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://timothelariviere.com/Fabulous-new/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><script>(()=>{var b=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,a=localStorage.getItem("theme");b&&a===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),b&&a==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),a==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script><link rel=stylesheet href=https://timothelariviere.com/Fabulous-new/main.bfd35e6b01dcede486fc98d3680c9464db3b7552d34b92a014910756df259c671ed77c30eeae23702252e179723ec64a9af42f2811882460b1c73af5d4168e89.css integrity="sha512-v9NeawHc7eSG/JjTaAyUZNs7dVLTS5KgFJEHVt8lnGce13ww7q4jcCJS4XlyPsZKmvQvKBGIJGCxxzr11BaOiQ==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>Architecture - Virtualized collections - Doks</title><meta name=description content="Doks is a Hugo theme for building secure, fast, and SEO-ready documentation websites, which you can easily update and customize."><link rel=canonical href=https://timothelariviere.com/Fabulous-new/docs/architecture/xamarin.forms/virtualized-collections/><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="Architecture - Virtualized collections"><meta property="og:description" content="Doks is a Hugo theme for building secure, fast, and SEO-ready documentation websites, which you can easily update and customize."><meta property="og:url" content="https://timothelariviere.com/Fabulous-new/docs/architecture/xamarin.forms/virtualized-collections/"><meta property="og:site_name" content="Doks"><meta property="article:published_time" content="2020-10-06T08:48:57+00:00"><meta property="article:modified_time" content="2020-10-06T08:48:57+00:00"><meta property="og:image" content="https://timothelariviere.com/Fabulous-new/doks.png"><meta property="og:image:alt" content="Doks"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@getdoks"><meta name=twitter:creator content="@henkverlinde"><meta name=twitter:title content="Architecture - Virtualized collections"><meta name=twitter:description content="Doks is a Hugo theme for building secure, fast, and SEO-ready documentation websites, which you can easily update and customize."><meta name=twitter:image content="https://timothelariviere.com/Fabulous-new/doks.png"><meta name=twitter:image:alt content="Architecture - Virtualized collections"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"https://timothelariviere.com/#/schema/organization/1","name":"Doks","url":"https://timothelariviere.com/","sameAs":["https://twitter.com/getdoks","https://github.com/h-enk/doks"],"logo":{"@type":"ImageObject","@id":"https://timothelariviere.com/#/schema/image/1","url":"https://timothelariviere.com/logo-doks.png","width":512,"height":512,"caption":"Doks"},"image":{"@id":"https://timothelariviere.com/#/schema/image/1"}},{"@type":"WebSite","@id":"https://timothelariviere.com/#/schema/website/1","url":"https://timothelariviere.com/","name":"Doks","description":"Doks is a Hugo theme for building secure, fast, and SEO-ready documentation websites, which you can easily update and customize.","publisher":{"@id":"https://timothelariviere.com/#/schema/organization/1"}},{"@type":"WebPage","@id":"https://timothelariviere.com/Fabulous-new/docs/architecture/xamarin.forms/virtualized-collections/","url":"https://timothelariviere.com/Fabulous-new/docs/architecture/xamarin.forms/virtualized-collections/","name":"Architecture - Virtualized collections","description":"Doks is a Hugo theme for building secure, fast, and SEO-ready documentation websites, which you can easily update and customize.","isPartOf":{"@id":"https://timothelariviere.com/#/schema/website/1"},"about":{"@id":"https://timothelariviere.com/#/schema/organization/1"},"datePublished":"2020-10-06T08:48:57CET","dateModified":"2020-10-06T08:48:57CET","breadcrumb":{"@id":"https://timothelariviere.com/Fabulous-new/docs/architecture/xamarin.forms/virtualized-collections/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"https://timothelariviere.com/Fabulous-new/docs/architecture/xamarin.forms/virtualized-collections/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://timothelariviere.com/Fabulous-new/docs/architecture/xamarin.forms/virtualized-collections/"]}]},{"@type":"BreadcrumbList","@id":"https://timothelariviere.com/Fabulous-new/docs/architecture/xamarin.forms/virtualized-collections/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"https://timothelariviere.com/Fabulous-new/","url":"https://timothelariviere.com/Fabulous-new/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@type":"WebPage","@id":"https://timothelariviere.com/Fabulous-new/docs/","url":"https://timothelariviere.com/Fabulous-new/docs/","name":"Docs"}},{"@type":"ListItem","position":3,"item":{"@type":"WebPage","@id":"https://timothelariviere.com/Fabulous-new/docs/architecture/","url":"https://timothelariviere.com/Fabulous-new/docs/architecture/","name":"Architecture"}},{"@type":"ListItem","position":4,"item":{"@type":"WebPage","@id":"https://timothelariviere.com/Fabulous-new/docs/architecture/xamarin.forms/","url":"https://timothelariviere.com/Fabulous-new/docs/architecture/xamarin.forms/","name":"Xamarin.Forms"}},{"@type":"ListItem","position":5,"item":{"@id":"https://timothelariviere.com/Fabulous-new/docs/architecture/xamarin.forms/virtualized-collections/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Article","@id":"https://timothelariviere.com/#/schema/article/1","headline":"Architecture - Virtualized collections","description":"Doks is a Hugo theme for building secure, fast, and SEO-ready documentation websites, which you can easily update and customize.","isPartOf":{"@id":"https://timothelariviere.com/Fabulous-new/docs/architecture/xamarin.forms/virtualized-collections/"},"mainEntityOfPage":{"@id":"https://timothelariviere.com/Fabulous-new/docs/architecture/xamarin.forms/virtualized-collections/"},"datePublished":"2020-10-06T08:48:57CET","dateModified":"2020-10-06T08:48:57CET","author":{"@id":"https://timothelariviere.com/#/schema/person/2"},"publisher":{"@id":"https://timothelariviere.com/#/schema/organization/1"},"image":{"@id":"https://timothelariviere.com/Fabulous-new/docs/architecture/xamarin.forms/virtualized-collections/#/schema/image/2"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Person","@id":"https://timothelariviere.com/#/schema/person/2","name":"Henk Verlinde","sameAs":["https://twitter.com/henkverlinde","https://www.linkedin.com/in/henkverlinde/","https://github.com/h-enk"]}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"https://timothelariviere.com/Fabulous-new/docs/architecture/xamarin.forms/virtualized-collections/#/schema/image/2","url":"https://timothelariviere.com/Fabulous-new/doks.png","contentUrl":"https://timothelariviere.com/Fabulous-new/doks.png","caption":"Architecture - Virtualized collections"}]}]}</script><meta name=theme-color content="#fff"><link rel=apple-touch-icon sizes=180x180 href=https://timothelariviere.com/Fabulous-new/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://timothelariviere.com/Fabulous-new/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://timothelariviere.com/Fabulous-new/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=https://timothelariviere.com/Fabulous-new/site.webmanifest></head><body class="docs single"><div class=header-bar></div><header class="navbar navbar-expand-md navbar-light doks-navbar"><nav class="container-xxl flex-wrap flex-md-nowrap" aria-label="Main navigation"><a class="navbar-brand p-0 me-auto" href=https://timothelariviere.com/Fabulous-new/ aria-label=Doks>Doks</a>
<button class="btn btn-menu d-block d-md-none order-5" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasDoks aria-controls=offcanvasDoks aria-label="Open main menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button><div class="offcanvas offcanvas-start border-0 py-md-1" tabindex=-1 id=offcanvasDoks data-bs-backdrop=true aria-labelledby=offcanvasDoksLabel><div class="header-bar d-md-none"></div><div class="offcanvas-header d-md-none"><h2 class="h5 offcanvas-title ps-2" id=offcanvasDoksLabel><a class=text-dark href=https://timothelariviere.com/Fabulous-new/>Doks</a></h2><button type=button class="btn-close text-reset me-2" data-bs-dismiss=offcanvas aria-label="Close main menu"></button></div><div class="offcanvas-body px-4"><h3 class="h6 text-uppercase mb-3 d-md-none">Main</h3><ul class="nav flex-column flex-md-row ms-md-n3"><li class=nav-item><a class="nav-link ps-0 py-1 active" href=https://timothelariviere.com/Fabulous-new/docs/prologue/introduction/>Docs</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=https://timothelariviere.com/Fabulous-new/blog/>Blog</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle ps-0 py-1" href=# id=navbarDropdownMenuLink role=button data-bs-toggle=dropdown aria-expanded=false>Get Started
<span class=dropdown-caret><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"/></svg></span></a><ul class="dropdown-menu dropdown-menu-main shadow rounded border-0" aria-labelledby=navbarDropdownMenuLink><li><a class=dropdown-item href=https://timothelariviere.com/Fabulous-new/docs/prologue/quick-start/>Quick Start</a></li><li><a class=dropdown-item href=https://getdoks.org/tutorial/introduction/>Tutorial</a></li></ul></li></ul><hr class="text-black-50 my-4 d-md-none"><h3 class="h6 text-uppercase mb-3 d-md-none">Socials</h3><ul class="nav flex-column flex-md-row ms-md-auto me-md-n5 pe-md-2"><li class=nav-item><a class="nav-link ps-0 py-1" href=https://github.com/h-enk/doks><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><small class="ms-2 d-md-none">GitHub</small></a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=https://twitter.com/getdoks><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-twitter"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg><small class="ms-2 d-md-none">Twitter</small></a></li></ul></div></div><button id=mode class="btn btn-link order-md-1" type=button aria-label="Toggle user interface mode">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></nav></header><nav class="doks-subnavbar py-2 sticky-lg-top" aria-label="Secondary navigation"><div class="container-xxl d-flex align-items-md-center"><form class="doks-search position-relative flex-grow-1 me-auto"><input id=search class="form-control is-search" type=search placeholder="Search docs..." aria-label="Search docs..." autocomplete=off><div id=suggestions class="shadow bg-white rounded d-none"></div></form><button class="btn doks-sidebar-toggle d-lg-none ms-3 order-3 collapsed" type=button data-bs-toggle=collapse data-bs-target=#doks-docs-nav aria-controls=doks-docs-nav aria-expanded=false aria-label="Toggle documentation navigation"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="doks doks-expand" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>Expand</title><polyline points="7 13 12 18 17 13"/><polyline points="7 6 12 11 17 6"/></svg><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" class="doks doks-collapse" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><title>Collapse</title><polyline points="17 11 12 6 7 11"/><polyline points="17 18 12 13 7 18"/></svg></button></div></nav><div class=container-xxl><aside class=doks-sidebar><nav id=doks-docs-nav class="collapse d-lg-none" aria-label="Tertiary navigation"><ul class="list-unstyled collapsible-sidebar"></ul></nav></aside></div><div class="wrap container-xxl" role=document><div class=content><div class="row flex-xl-nowrap"><div class="col-lg-5 col-xl-4 docs-sidebar d-none d-lg-block"><nav class=docs-links aria-label="Main navigation"><ul class="list-unstyled collapsible-sidebar"></ul></nav></div><nav class="docs-toc d-none d-xl-block col-xl-3" aria-label="Secondary navigation"><div class=page-links><h3>On this page</h3><nav id=TableOfContents><ul><li><a href=#usages>Usages</a></li><li><a href=#how-listview-and-collectionview-work-in-xamarinforms>How ListView and CollectionView work in Xamarin.Forms</a></li><li><a href=#how-it-works-in-fabulous>How it works in Fabulous</a><ul><li><a href=#simple-collections-aka-not-grouped>Simple collections (aka not grouped)</a></li><li><a href=#grouped-collections>Grouped collections</a></li></ul></li></ul></nav></div></nav><main class="docs-content col-lg-11 col-xl-9"><h1>Architecture - Virtualized collections</h1><p class=lead>Doks is a Hugo theme for building secure, fast, and SEO-ready documentation websites, which you can easily update and customize.</p><nav class=d-xl-none aria-label="Quaternary navigation"><div class=page-links><h3>On this page</h3><nav id=TableOfContents><ul><li><a href=#usages>Usages</a></li><li><a href=#how-listview-and-collectionview-work-in-xamarinforms>How ListView and CollectionView work in Xamarin.Forms</a></li><li><a href=#how-it-works-in-fabulous>How it works in Fabulous</a><ul><li><a href=#simple-collections-aka-not-grouped>Simple collections (aka not grouped)</a></li><li><a href=#grouped-collections>Grouped collections</a></li></ul></li></ul></nav></div></nav><p>Virtualized collection enables displaying a scrolling list of data while only instantiating the visible rows.
When scrolling, the no longer visible rows are reused and updated with the new data.</p><p>In Xamarin.Forms, this is done via 2 controls: ListView and CollectionView.
Also those controls support grouping data and displaying a group header/footer.</p><p>My main idea was to let the user pass in its data source and declare a template function (as well as 2 others for header/footer).
Fabulous would just remap the data source (<code>Seq.map templateFn items</code>) and pass it to Xamarin.Forms, avoiding enumeration.</p><h2 id=usages>Usages <a href=#usages class=anchor aria-hidden=true>#</a></h2><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fs data-lang=fs><span style=color:#900;font-weight:700>let</span> <span style=color:#900;font-weight:700>items</span> <span style=color:#900;font-weight:700>=</span> <span style=color:#900;font-weight:700>[</span> <span style=color:#099>1</span> <span style=color:#458;font-weight:700>..</span> <span style=color:#099>1000</span> <span style=color:#900;font-weight:700>]</span>

<span style=color:#900;font-weight:700>ListView(items)</span>
    <span style=color:#900;font-weight:700>(fun</span> <span style=color:#900;font-weight:700>item</span> <span style=color:#900;font-weight:700>-&gt;</span> <span style=color:#900;font-weight:700>TextCell($&#34;{item}&#34;))</span>

<span style=color:#900;font-weight:700>CollectionView(items)</span>
    <span style=color:#900;font-weight:700>(fun</span> <span style=color:#900;font-weight:700>item</span> <span style=color:#900;font-weight:700>-&gt;</span> <span style=color:#900;font-weight:700>Label($&#34;{item}&#34;))</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fs data-lang=fs><span style=color:#900;font-weight:700>//</span> <span style=color:#900;font-weight:700>According</span> <span style=color:#000;font-weight:700>to </span><span style=color:#900;font-weight:700>Xamarin.Forms</span> <span style=color:#900;font-weight:700>documentation,</span> <span style=color:#900;font-weight:700>when</span> <span style=color:#900;font-weight:700>grouping,</span> <span style=color:#900;font-weight:700>data</span> <span style=color:#000;font-weight:700>source </span><span style=color:#900;font-weight:700>should</span> <span style=color:#900;font-weight:700>be</span> <span style=color:#900;font-weight:700>an</span> <span style=color:#900;font-weight:700>IEnumerable</span> <span style=color:#000;font-weight:700>of </span><span style=color:#900;font-weight:700>IEnumerable</span>
<span style=color:#000;font-weight:700>type </span><span style=color:#900;font-weight:700>Group(headerData:</span> <span style=color:#900;font-weight:700>string,</span> <span style=color:#900;font-weight:700>footerData:</span> <span style=color:#900;font-weight:700>string,</span> <span style=color:#900;font-weight:700>items:</span> <span style=color:#900;font-weight:700>IEnumerable&lt;int&gt;)</span> <span style=color:#900;font-weight:700>=</span>
    <span style=color:#900;font-weight:700>inherit</span> <span style=color:#900;font-weight:700>ObservableCollection&lt;int&gt;(items)</span>
    <span style=color:#900;font-weight:700>member</span> <span style=color:#900;font-weight:700>_.HeaderData</span> <span style=color:#900;font-weight:700>=</span> <span style=color:#900;font-weight:700>headerData</span>
    <span style=color:#900;font-weight:700>member</span> <span style=color:#900;font-weight:700>_.FooterData</span> <span style=color:#900;font-weight:700>=</span> <span style=color:#900;font-weight:700>footerData</span>

<span style=color:#900;font-weight:700>let</span> <span style=color:#900;font-weight:700>groups</span> <span style=color:#900;font-weight:700>=</span>
    <span style=color:#900;font-weight:700>ObservableCollection&lt;Group&gt;(</span>
        <span style=color:#900;font-weight:700>[</span> <span style=color:#900;font-weight:700>for</span> <span style=color:#000;font-weight:700>i </span><span style=color:#900;font-weight:700>=</span> <span style=color:#099>0</span> <span style=color:#458;font-weight:700>..</span> <span style=color:#099>100</span> <span style=color:#000;font-weight:700>do
</span><span style=color:#000;font-weight:700></span>            <span style=color:#900;font-weight:700>Group($&#34;Header</span> <span style=color:#900;font-weight:700>{i}&#34;,</span> <span style=color:#900;font-weight:700>$&#34;Footer</span> <span style=color:#900;font-weight:700>{i}&#34;,</span> <span style=color:#900;font-weight:700>[1</span> <span style=color:#458;font-weight:700>..</span> <span style=color:#099>100</span><span style=color:#900;font-weight:700>])</span> <span style=color:#900;font-weight:700>]</span>
    <span style=color:#900;font-weight:700>)</span>

<span style=color:#900;font-weight:700>//</span> <span style=color:#900;font-weight:700>ListView</span> <span style=color:#900;font-weight:700>has</span> <span style=color:#900;font-weight:700>no</span> <span style=color:#900;font-weight:700>Footer</span> <span style=color:#900;font-weight:700>for</span> <span style=color:#900;font-weight:700>groups</span>
<span style=color:#900;font-weight:700>GroupedListView(groups)</span>
    <span style=color:#900;font-weight:700>(fun</span> <span style=color:#900;font-weight:700>group</span> <span style=color:#900;font-weight:700>-&gt;</span> <span style=color:#900;font-weight:700>TextCell(group.HeaderData))</span>
    <span style=color:#900;font-weight:700>(fun</span> <span style=color:#900;font-weight:700>item</span> <span style=color:#900;font-weight:700>-&gt;</span> <span style=color:#900;font-weight:700>TextCell($&#34;{item}&#34;))</span>

<span style=color:#900;font-weight:700>GroupedCollectionView(items)</span>
    <span style=color:#900;font-weight:700>(fun</span> <span style=color:#900;font-weight:700>group</span> <span style=color:#900;font-weight:700>-&gt;</span> <span style=color:#900;font-weight:700>Label(group.HeaderData))</span>
    <span style=color:#900;font-weight:700>(fun</span> <span style=color:#900;font-weight:700>item</span> <span style=color:#900;font-weight:700>-&gt;</span> <span style=color:#900;font-weight:700>Label($&#34;{item}&#34;)</span>
    <span style=color:#900;font-weight:700>(fun</span> <span style=color:#900;font-weight:700>group</span> <span style=color:#900;font-weight:700>-&gt;</span> <span style=color:#900;font-weight:700>Label(group.FooterData))</span>
</code></pre></div><h2 id=how-listview-and-collectionview-work-in-xamarinforms>How ListView and CollectionView work in Xamarin.Forms <a href=#how-listview-and-collectionview-work-in-xamarinforms class=anchor aria-hidden=true>#</a></h2><p>Virtualization in ListView/CollectionView works by combining 2 properties:</p><ul><li><code>ItemsSource</code>: a list of raw data</li><li><code>DataTemplate</code>: a template object used to describe what the row should look like</li></ul><p>Given the MVVM nature of XF, row reuse is mostly driven by bindings.
DataTemplate doesn&rsquo;t know about the raw data it will receive and only setups binding.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=color:navy>&lt;ListView</span> <span style=color:teal>ItemsSource=</span><span style=color:#d14>&#34;{Binding Items}&#34;</span><span style=color:navy>&gt;</span>
    <span style=color:navy>&lt;ListView.ItemTemplate&gt;</span>
        <span style=color:navy>&lt;DataTemplate&gt;</span>
            <span style=color:navy>&lt;TextCell</span> <span style=color:teal>Text=</span><span style=color:#d14>&#34;{Binding MyProperty}&#34;</span> <span style=color:navy>/&gt;</span>
        <span style=color:navy>&lt;DataTemplate&gt;</span>
    <span style=color:navy>&lt;/ListView.ItemTemplate&gt;</span>
<span style=color:navy>&lt;/ListView&gt;</span>
</code></pre></div><p>Xamarin.Forms creates a row using the <code>DataTemplate</code> and sets its <code>BindingContext</code> with the raw item.
This triggers refresh of the row UI.
Same on row reuse, XF sets the new raw item into <code>BindingContext</code> and refreshes the bindings.</p><p>This model doesn&rsquo;t work with Fabulous at all, due to the lack of Binding.
Fortunately, we can work with <code>DataTemplateSelector</code> to access the current item before returning the appropriate <code>DataTemplate</code>.
This allows Fabulous to support virtualization.</p><h2 id=how-it-works-in-fabulous>How it works in Fabulous <a href=#how-it-works-in-fabulous class=anchor aria-hidden=true>#</a></h2><p>Semantically speaking, our <code>Widget</code> is very close to <code>DataTemplate</code>. They both describe what a specific piece of UI should look like. The main difference is that <code>DataTemplate</code> doesn&rsquo;t know of the data it will work with in advance, whereas <code>Widget</code> has been built with that data.</p><p>So the main challenge was to make the 2 concepts compatible.</p><h3 id=simple-collections-aka-not-grouped>Simple collections (aka not grouped) <a href=#simple-collections-aka-not-grouped class=anchor aria-hidden=true>#</a></h3><h4 id=storing-data-and-the-template-function>Storing data and the template function <a href=#storing-data-and-the-template-function class=anchor aria-hidden=true>#</a></h4><p>In Fabulous v1, we were creating all <code>ViewElement</code> items (<code>Widget</code> in v2) on each view update. This can be problematic in case you have a large number of items.</p><p>Actually thanks to how virtualization works, we only need to &ldquo;process&rdquo; a couple of items for the visible rows.
No need to go create all widgets on each view update.</p><p>To support that, the following type has been created:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fs data-lang=fs><span style=color:#000;font-weight:700>type </span><span style=color:#900;font-weight:700>WidgetItems&lt;&#39;T&gt;</span> <span style=color:#900;font-weight:700>=</span>
    <span style=color:#900;font-weight:700>{</span>
        <span style=color:#900;font-weight:700>//</span> <span style=color:#900;font-weight:700>The</span> <span style=color:#900;font-weight:700>raw</span> <span style=color:#000;font-weight:700>list of </span><span style=color:#900;font-weight:700>data</span> <span style=color:#900;font-weight:700>provided</span> <span style=color:#900;font-weight:700>by</span> <span style=color:#900;font-weight:700>the</span> <span style=color:#900;font-weight:700>user</span>
        <span style=color:#900;font-weight:700>OriginalItems:</span> <span style=color:#900;font-weight:700>IEnumerable&lt;&#39;T&gt;</span>
       
        <span style=color:#900;font-weight:700>//</span> <span style=color:#900;font-weight:700>Function</span> <span style=color:#000;font-weight:700>to convert </span><span style=color:#900;font-weight:700>one</span> <span style=color:#900;font-weight:700>item</span> <span style=color:#000;font-weight:700>to </span><span style=color:#900;font-weight:700>a</span> <span style=color:#900;font-weight:700>widget</span>
        <span style=color:#900;font-weight:700>Template:</span> <span style=color:#900;font-weight:700>&#39;T</span> <span style=color:#900;font-weight:700>-&gt;</span> <span style=color:#900;font-weight:700>Widget</span>
    <span style=color:#900;font-weight:700>}</span>
</code></pre></div><p>This <code>WidgetItems</code> is created by the function <code>ViewHelpers.buildItems</code> and is stored directly in the <code>ItemsSource</code> scalar attribute.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fs data-lang=fs><span style=color:#900;font-weight:700>let</span> <span style=color:#900;font-weight:700>buildItems&lt;&#39;msg,</span> <span style=color:#900;font-weight:700>&#39;marker,</span> <span style=color:#900;font-weight:700>&#39;itemData,</span> <span style=color:#900;font-weight:700>&#39;itemMarker&gt;</span> <span style=color:#000;font-weight:700>key </span><span style=color:#900;font-weight:700>attrDef</span> <span style=color:#900;font-weight:700>(items:</span> <span style=color:#900;font-weight:700>seq&lt;&#39;itemData&gt;)</span> <span style=color:#900;font-weight:700>(itemTemplate:</span> <span style=color:#900;font-weight:700>&#39;itemData</span> <span style=color:#900;font-weight:700>-&gt;</span> <span style=color:#900;font-weight:700>WidgetBuilder&lt;&#39;msg,</span> <span style=color:#900;font-weight:700>&#39;itemMarker&gt;)</span> <span style=color:#900;font-weight:700>=</span> <span style=color:#900;font-weight:700>(...)</span>

<span style=color:#900;font-weight:700>static</span> <span style=color:#900;font-weight:700>member</span> <span style=color:#900;font-weight:700>inline</span> <span style=color:#900;font-weight:700>ListView&lt;&#39;msg,</span> <span style=color:#900;font-weight:700>&#39;itemData,</span> <span style=color:#900;font-weight:700>&#39;itemMarker</span> <span style=color:#900;font-weight:700>when</span> <span style=color:#900;font-weight:700>&#39;itemMarker</span> <span style=color:#900;font-weight:700>:&gt;</span> <span style=color:#900;font-weight:700>ICell&gt;(items:</span> <span style=color:#900;font-weight:700>seq&lt;&#39;itemData&gt;)</span> <span style=color:#900;font-weight:700>=</span>
    <span style=color:#900;font-weight:700>ViewHelpers.buildItems&lt;&#39;msg,</span> <span style=color:#900;font-weight:700>IListView,</span> <span style=color:#900;font-weight:700>&#39;itemData,</span> <span style=color:#900;font-weight:700>&#39;itemMarker&gt;</span> <span style=color:#900;font-weight:700>ViewKeys.ListView</span> <span style=color:#900;font-weight:700>ItemsViewOfCell.ItemsSource</span> <span style=color:#900;font-weight:700>items</span>
</code></pre></div><p><em>Note the use of <code>'itemMarker</code> to enforce the type of widget items</em></p><p>Keeping the original items allows us to directly compare them on each update to determine if we need to update the UI.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fs data-lang=fs><span style=color:#900;font-weight:700>(fun</span> <span style=color:#900;font-weight:700>(a,</span> <span style=color:#900;font-weight:700>b)</span> <span style=color:#900;font-weight:700>-&gt;</span> <span style=color:#900;font-weight:700>ScalarAttributeComparers.equalityCompare(a.OriginalItems,</span> <span style=color:#900;font-weight:700>b.OriginalItems))</span>
</code></pre></div><p>Currently, scalar attributes in Fabulous have 2 generic parameters: the <code>'inputType</code> and <code>'modelType</code>.</p><p>The <code>'inputType</code> is what we expect the users to provide us.
The <code>'modelType</code> is an optimized representation of the same data (eg. <code>'inputType</code> is <code>int list</code>, <code>'modelType</code> will be <code>int[]</code>).</p><p>Before storing the attribute value, we convert <code>'inputType</code> to <code>'modelType</code> through the <code>Convert</code> function declared in the <code>ScalarAttributeDefinition</code>; <code>'inputType</code> is never stored.</p><p>But the comparison function shown just above is only done between 2 <code>'modelType</code>s, but ListView/CollectionView expect an <code>IEnumerable</code> and not a <code>WidgetItems</code>.</p><p>So to support this, we need another generic parameter <code>'valueType</code> and the corresponding <code>ConvertValue: 'modelType -> 'valueType</code> function.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fs data-lang=fs><span style=color:#000;font-weight:700>type </span><span style=color:#900;font-weight:700>ScalarAttributeDefinition&lt;&#39;inputType,</span> <span style=color:#900;font-weight:700>&#39;modelType,</span> <span style=color:#900;font-weight:700>&#39;valueType&gt;</span> <span style=color:#900;font-weight:700>=</span>
    <span style=color:#900;font-weight:700>{</span> <span style=color:#900;font-weight:700>(...)</span>
      <span style=color:#900;font-weight:700>Compare:</span> <span style=color:#900;font-weight:700>&#39;modelType</span> <span style=color:#900;font-weight:700>-&gt;</span> <span style=color:#900;font-weight:700>&#39;modelType</span>
      <span style=color:#900;font-weight:700>ConvertValue:</span> <span style=color:#900;font-weight:700>&#39;modelType</span> <span style=color:#900;font-weight:700>-&gt;</span> <span style=color:#900;font-weight:700>&#39;valueType</span> <span style=color:#900;font-weight:700>}</span>
</code></pre></div><p>With this, we can still store and compare <code>WidgetItems</code>, but when we actually need to apply the value to the XF property, we call <code>ConvertValue</code> to transform it. Attributes that don&rsquo;t need conversion can use the <code>id</code> function to make it transparent.</p><p>For <code>WidgetItems</code>, we build an IEnumerable on the fly using the original items and the template function before assigning it to the XF property <code>ItemsSource</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fs data-lang=fs><span style=color:#900;font-weight:700>(fun</span> <span style=color:#900;font-weight:700>modelValue</span> <span style=color:#900;font-weight:700>-&gt;</span> <span style=color:#900;font-weight:700>seq</span> <span style=color:#900;font-weight:700>{</span> <span style=color:#900;font-weight:700>for</span> <span style=color:#900;font-weight:700>x</span> <span style=color:#900;font-weight:700>in</span> <span style=color:#900;font-weight:700>modelValue.OriginalItems</span> <span style=color:#000;font-weight:700>do </span><span style=color:#900;font-weight:700>modelValue.Template</span> <span style=color:#900;font-weight:700>x</span> <span style=color:#900;font-weight:700>})</span>
</code></pre></div><p>Now Xamarin.Forms has a list of Widgets, and thanks to <code>seq</code>, it will only enumerate the items it needs to display.</p><h4 id=loading-widgets-into-rows>Loading Widgets into rows <a href=#loading-widgets-into-rows class=anchor aria-hidden=true>#</a></h4><p>Unlike DataTemplate in MVVM apps, instead of setting bindings to capture the raw data inside <code>BindingContext</code>, we now have a <code>Widget</code>.</p><p>To make it work, we need 2 things:</p><ul><li>A DataTemplateSelector that will know which DataTemplate to create based on the widget</li><li>A DataTemplate that will listen to <code>BindingContextChanged</code> and run the Reconciler when a widget is attached to the row</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fs data-lang=fs><span style=color:#900;font-weight:700>//</span> <span style=color:#900;font-weight:700>IsHeader</span> <span style=color:#000;font-weight:700>is only </span><span style=color:#900;font-weight:700>for</span> <span style=color:#900;font-weight:700>grouping</span>
<span style=color:#000;font-weight:700>type </span><span style=color:#900;font-weight:700>WidgetDataTemplateSelector</span> <span style=color:#900;font-weight:700>internal</span> <span style=color:#900;font-weight:700>(node:</span> <span style=color:#900;font-weight:700>IViewNode,</span> <span style=color:#900;font-weight:700>itemType:</span> <span style=color:#900;font-weight:700>VirtualizedItemType)</span> <span style=color:#900;font-weight:700>=</span>
    <span style=color:#900;font-weight:700>inherit</span> <span style=color:#900;font-weight:700>DataTemplateSelector()</span>
    
    <span style=color:#900;font-weight:700>///</span> <span style=color:#900;font-weight:700>Reuse</span> <span style=color:#900;font-weight:700>data</span> <span style=color:#900;font-weight:700>template</span> <span style=color:#900;font-weight:700>for</span> <span style=color:#900;font-weight:700>already</span> <span style=color:#900;font-weight:700>known</span> <span style=color:#900;font-weight:700>widget</span> <span style=color:#900;font-weight:700>target</span> <span style=color:#000;font-weight:700>type
</span><span style=color:#000;font-weight:700></span>    <span style=color:#900;font-weight:700>let</span> <span style=color:#900;font-weight:700>cache</span> <span style=color:#900;font-weight:700>=</span> <span style=color:#900;font-weight:700>Dictionary&lt;Type,</span> <span style=color:#900;font-weight:700>WidgetDataTemplate&gt;()</span>
    
    <span style=color:#900;font-weight:700>override</span> <span style=color:#900;font-weight:700>_.OnSelectTemplate(item,</span> <span style=color:#900;font-weight:700>_)</span> <span style=color:#900;font-weight:700>=</span>
        <span style=color:#900;font-weight:700>let</span> <span style=color:#900;font-weight:700>widget</span> <span style=color:#900;font-weight:700>=</span> <span style=color:#900;font-weight:700>BindableHelpers.getWidgetFromBindingContext</span> <span style=color:#900;font-weight:700>itemType</span> <span style=color:#900;font-weight:700>item</span>
        <span style=color:#900;font-weight:700>let</span> <span style=color:#900;font-weight:700>widgetDefinition</span> <span style=color:#900;font-weight:700>=</span> <span style=color:#900;font-weight:700>WidgetDefinitionStore.get</span> <span style=color:#900;font-weight:700>widget.Key</span>
        <span style=color:#900;font-weight:700>let</span> <span style=color:#900;font-weight:700>targetType</span> <span style=color:#900;font-weight:700>=</span> <span style=color:#900;font-weight:700>widgetDefinition.GetTargetType(widget)</span>
        <span style=color:#900;font-weight:700>match</span> <span style=color:#900;font-weight:700>cache.TryGetValue(targetType)</span> <span style=color:#900;font-weight:700>with</span>
        <span style=color:#900;font-weight:700>|</span> <span style=color:#900;font-weight:700>true,</span> <span style=color:#900;font-weight:700>dataTemplate</span> <span style=color:#900;font-weight:700>-&gt;</span> <span style=color:#900;font-weight:700>dataTemplate</span>
        <span style=color:#900;font-weight:700>|</span> <span style=color:#900;font-weight:700>false,</span> <span style=color:#900;font-weight:700>_</span> <span style=color:#900;font-weight:700>-&gt;</span>
            <span style=color:#900;font-weight:700>let</span> <span style=color:#900;font-weight:700>dataTemplate</span> <span style=color:#900;font-weight:700>=</span> <span style=color:#900;font-weight:700>WidgetDataTemplate(targetType,</span> <span style=color:#900;font-weight:700>isHeader,</span> <span style=color:#900;font-weight:700>node)</span>
            <span style=color:#900;font-weight:700>cache.Add(targetType,</span> <span style=color:#900;font-weight:700>dataTemplate)</span>
            <span style=color:#900;font-weight:700>dataTemplate</span>
</code></pre></div><p>Note that like said earlier, DataTemplate are created <em>before</em> knowing which value they will host.
This means we can only create an empty row for now.
So to enable row reuse later, we extract the root target type of a widget and create an empty row with it.</p><p>eg.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fs data-lang=fs><span style=color:#900;font-weight:700>fun</span> <span style=color:#900;font-weight:700>item</span> <span style=color:#900;font-weight:700>-&gt;</span>
    <span style=color:#900;font-weight:700>ViewCell(</span>
        <span style=color:#900;font-weight:700>Grid(...)</span>
    <span style=color:#900;font-weight:700>)</span>
</code></pre></div><p>will have a target type of <code>ViewCell</code> and we create an empty <code>ViewCell</code>.</p><p><em>Side note:</em> Given the potential high cost of instantiate a lot of <code>View.lazy'</code>, its use is not allowed in virtualized collections.</p><p>This DataTemplateSelector instantiates a <code>WidgetDataTemplate</code> that will create the appropriate XF control and listen to <code>BindingContextChanged</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fs data-lang=fs><span style=color:#900;font-weight:700>///</span> <span style=color:#000;font-weight:700>Create </span><span style=color:#900;font-weight:700>a</span> <span style=color:#900;font-weight:700>DataTemplate</span> <span style=color:#900;font-weight:700>for</span> <span style=color:#900;font-weight:700>a</span> <span style=color:#900;font-weight:700>specific</span> <span style=color:#900;font-weight:700>root</span> <span style=color:#000;font-weight:700>type </span><span style=color:#900;font-weight:700>(TextCell,</span> <span style=color:#900;font-weight:700>ViewCell,</span> <span style=color:#900;font-weight:700>etc.)</span>
<span style=color:#900;font-weight:700>///</span> <span style=color:#900;font-weight:700>that</span> <span style=color:#900;font-weight:700>listen</span> <span style=color:#900;font-weight:700>for</span> <span style=color:#900;font-weight:700>BindingContext</span> <span style=color:#900;font-weight:700>change</span> <span style=color:#000;font-weight:700>to </span><span style=color:#900;font-weight:700>apply</span> <span style=color:#900;font-weight:700>the</span> <span style=color:#900;font-weight:700>Widget</span> <span style=color:#900;font-weight:700>content</span> <span style=color:#000;font-weight:700>to </span><span style=color:#900;font-weight:700>the</span> <span style=color:#900;font-weight:700>cell</span>
<span style=color:#000;font-weight:700>type </span><span style=color:#900;font-weight:700>WidgetDataTemplate(``type``,</span> <span style=color:#900;font-weight:700>itemType,</span> <span style=color:#900;font-weight:700>parent:</span> <span style=color:#900;font-weight:700>IViewNode)</span> <span style=color:#900;font-weight:700>=</span>
    <span style=color:#900;font-weight:700>inherit</span> <span style=color:#900;font-weight:700>DataTemplate(fun</span> <span style=color:#900;font-weight:700>()</span> <span style=color:#900;font-weight:700>-&gt;</span>
        <span style=color:#900;font-weight:700>let</span> <span style=color:#900;font-weight:700>bindableObject</span> <span style=color:#900;font-weight:700>=</span> <span style=color:#900;font-weight:700>Activator.CreateInstance</span> <span style=color:#900;font-weight:700>``type``</span> <span style=color:#900;font-weight:700>:?&gt;</span> <span style=color:#900;font-weight:700>BindableObject</span>
        
        <span style=color:#900;font-weight:700>let</span> <span style=color:#900;font-weight:700>viewNode</span> <span style=color:#900;font-weight:700>=</span> <span style=color:#900;font-weight:700>ViewNode(ValueSome</span> <span style=color:#900;font-weight:700>parent,</span> <span style=color:#900;font-weight:700>parent.TreeContext,</span> <span style=color:#900;font-weight:700>WeakReference(bindableObject))</span>
        <span style=color:#900;font-weight:700>bindableObject.SetValue(ViewNode.ViewNodeProperty,</span> <span style=color:#900;font-weight:700>viewNode)</span>
        
        <span style=color:#900;font-weight:700>let</span> <span style=color:#900;font-weight:700>onBindingContextChanged</span> <span style=color:#900;font-weight:700>=</span> <span style=color:#900;font-weight:700>BindableHelpers.createOnBindingContextChanged</span> <span style=color:#900;font-weight:700>parent.TreeContext.CanReuseView</span> <span style=color:#900;font-weight:700>itemType</span> <span style=color:#900;font-weight:700>bindableObject</span>
        <span style=color:#900;font-weight:700>bindableObject.BindingContextChanged.Add</span> <span style=color:#900;font-weight:700>(fun</span> <span style=color:#900;font-weight:700>_</span> <span style=color:#900;font-weight:700>-&gt;</span> <span style=color:#900;font-weight:700>onBindingContextChanged</span> <span style=color:#900;font-weight:700>())</span>
        
        <span style=color:#900;font-weight:700>bindableObject</span> <span style=color:#900;font-weight:700>:&gt;</span> <span style=color:#900;font-weight:700>obj</span>
    <span style=color:#900;font-weight:700>)</span>
</code></pre></div><p>For fresh rows, Xamarin.Forms will execute that function and then set the <code>BindingContext</code> with the widget from our list. When XF reuses a row, it will set the new widget in the <code>BindingContext</code> as well.
Each time, we call the Reconciler to update the row.</p><p>Final step is to pass this <code>WidgetDataTemplateSelector</code> in the XF property <code>ItemTemplate</code>.
Since it will never change, we assign it when creating the controls.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fs data-lang=fs><span style=color:#900;font-weight:700>///</span> <span style=color:#900;font-weight:700>Force</span> <span style=color:#900;font-weight:700>ListView</span> <span style=color:#000;font-weight:700>to </span><span style=color:#900;font-weight:700>recycle</span> <span style=color:#900;font-weight:700>rows</span> <span style=color:#900;font-weight:700>because</span> <span style=color:#900;font-weight:700>DataTemplateSelector</span> <span style=color:#900;font-weight:700>disables</span> <span style=color:#900;font-weight:700>it</span> <span style=color:#900;font-weight:700>by</span> <span style=color:#900;font-weight:700>default,</span> <span style=color:#000;font-weight:700>only </span><span style=color:#900;font-weight:700>possible</span> <span style=color:#900;font-weight:700>in</span> <span style=color:#900;font-weight:700>ctor</span>
<span style=color:#900;font-weight:700>///</span> <span style=color:#900;font-weight:700>CollectionView</span> <span style=color:#900;font-weight:700>recycles</span> <span style=color:#900;font-weight:700>by</span> <span style=color:#900;font-weight:700>default</span>
<span style=color:#000;font-weight:700>type </span><span style=color:#900;font-weight:700>FabulousListView()</span> <span style=color:#900;font-weight:700>=</span> <span style=color:#900;font-weight:700>inherit</span> <span style=color:#900;font-weight:700>ListView(ListViewCachingStrategy.RecycleElement)</span>

<span style=color:#900;font-weight:700>let</span> <span style=color:#900;font-weight:700>ListView</span> <span style=color:#900;font-weight:700>=</span> <span style=color:#900;font-weight:700>Widgets.registerWithAdditionalSetup&lt;FabulousListView&gt;(fun</span> <span style=color:#900;font-weight:700>target</span> <span style=color:#900;font-weight:700>node</span> <span style=color:#900;font-weight:700>-&gt;</span>
    <span style=color:#900;font-weight:700>target.ItemTemplate</span> <span style=color:#900;font-weight:700>&lt;-</span> <span style=color:#900;font-weight:700>SimpleWidgetDataTemplateSelector(node)</span>
<span style=color:#900;font-weight:700>)</span>
<span style=color:#900;font-weight:700>let</span> <span style=color:#900;font-weight:700>CollectionView</span> <span style=color:#900;font-weight:700>=</span> <span style=color:#900;font-weight:700>Widgets.registerWithAdditionalSetup&lt;Xamarin.Forms.CollectionView&gt;(fun</span> <span style=color:#900;font-weight:700>target</span> <span style=color:#900;font-weight:700>node</span> <span style=color:#900;font-weight:700>-&gt;</span>
    <span style=color:#900;font-weight:700>target.ItemTemplate</span> <span style=color:#900;font-weight:700>&lt;-</span> <span style=color:#900;font-weight:700>SimpleWidgetDataTemplateSelector(node)</span>
<span style=color:#900;font-weight:700>)</span>
</code></pre></div><p>A <code>registerWithAdditionalSetup</code> was needed because <code>DataTemplateSelector</code> requires access to the <code>ViewNode</code> of the ListView/CollectionView, and it was not possible to do it in the constructor of the controls.</p><h3 id=grouped-collections>Grouped collections <a href=#grouped-collections class=anchor aria-hidden=true>#</a></h3><p>Grouped ListView/CollectionView is slightly different.
Instead of having a 1-dimensional enumerable of raw data, we have a 2-dimension one (eg. <code>IEnumerable&lt;IEnumerable&lt;T>></code>)</p><p>To support this with everything we saw just before, <code>GroupItem</code> has been created.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fs data-lang=fs><span style=color:#000;font-weight:700>type </span><span style=color:#900;font-weight:700>GroupItem(header:</span> <span style=color:#900;font-weight:700>Widget,</span> <span style=color:#900;font-weight:700>footer:</span> <span style=color:#900;font-weight:700>Widget,</span> <span style=color:#900;font-weight:700>source:</span> <span style=color:#900;font-weight:700>IEnumerable&lt;Widget&gt;)</span> <span style=color:#900;font-weight:700>=</span>
    <span style=color:#900;font-weight:700>member</span> <span style=color:#900;font-weight:700>_.Header</span> <span style=color:#900;font-weight:700>=</span> <span style=color:#900;font-weight:700>header</span>
    <span style=color:#900;font-weight:700>member</span> <span style=color:#900;font-weight:700>_.Footer</span> <span style=color:#900;font-weight:700>=</span> <span style=color:#900;font-weight:700>footer</span>
    <span style=color:#900;font-weight:700>interface</span> <span style=color:#900;font-weight:700>IEnumerable&lt;Widget&gt;</span> <span style=color:#900;font-weight:700>with</span>
        <span style=color:#900;font-weight:700>member</span> <span style=color:#900;font-weight:700>this.GetEnumerator():</span> <span style=color:#900;font-weight:700>IEnumerator&lt;Widget&gt;</span> <span style=color:#900;font-weight:700>=</span> <span style=color:#900;font-weight:700>source.GetEnumerator()</span>
        <span style=color:#900;font-weight:700>member</span> <span style=color:#900;font-weight:700>this.GetEnumerator():</span> <span style=color:#900;font-weight:700>IEnumerator</span> <span style=color:#900;font-weight:700>=</span> <span style=color:#900;font-weight:700>source.GetEnumerator()</span>
</code></pre></div><p>Instead of applying a list of <code>IEnumerable&lt;Widget></code> to XF property <code>ItemsSource</code>, we apply a list of <code>IEnumerable&lt;GroupItem></code>.</p><p>The builder function takes 3 template functions instead of 1: the group header template, the item template and the group footer template. All of which are called on <code>ConvertValue</code> to create the list of &lsquo;GroupItem&rsquo;.</p><p>Since the data source is different, we need a different <code>DataTemplate</code> for XF properties <code>GroupHeaderTemplate</code> and <code>GroupFooterTemplate</code>.
Even with grouping enabled, <code>ItemTemplate</code> remains a simple <code>Widget</code> -> row.</p><p><code>GroupedWidgetDataTemplateSelector</code> will either use the <code>Header</code> or <code>Footer</code> widgets to create the corresponding rows.</p><p>And when registering the ListView/CollectionView types, we enable the <code>IsGrouped</code> flag.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fs data-lang=fs><span style=color:#900;font-weight:700>let</span> <span style=color:#900;font-weight:700>GroupedListView</span> <span style=color:#900;font-weight:700>=</span> <span style=color:#900;font-weight:700>Widgets.registerWithAdditionalSetup&lt;FabulousListView&gt;(fun</span> <span style=color:#900;font-weight:700>target</span> <span style=color:#900;font-weight:700>node</span> <span style=color:#900;font-weight:700>-&gt;</span>
    <span style=color:#900;font-weight:700>target.ItemTemplate</span> <span style=color:#900;font-weight:700>&lt;-</span> <span style=color:#900;font-weight:700>SimpleWidgetDataTemplateSelector(node)</span>
    <span style=color:#900;font-weight:700>target.GroupHeaderTemplate</span> <span style=color:#900;font-weight:700>&lt;-</span> <span style=color:#900;font-weight:700>GroupedWidgetDataTemplateSelector(node,</span> <span style=color:#900;font-weight:700>Header)</span>
    <span style=color:#900;font-weight:700>target.IsGroupingEnabled</span> <span style=color:#900;font-weight:700>&lt;-</span> <span style=color:#000;font-weight:700>true
</span><span style=color:#000;font-weight:700></span><span style=color:#900;font-weight:700>)</span>
<span style=color:#900;font-weight:700>let</span> <span style=color:#900;font-weight:700>GroupedCollectionView</span> <span style=color:#900;font-weight:700>=</span> <span style=color:#900;font-weight:700>Widgets.registerWithAdditionalSetup&lt;Xamarin.Forms.CollectionView&gt;(fun</span> <span style=color:#900;font-weight:700>target</span> <span style=color:#900;font-weight:700>node</span> <span style=color:#900;font-weight:700>-&gt;</span>
    <span style=color:#900;font-weight:700>target.ItemTemplate</span> <span style=color:#900;font-weight:700>&lt;-</span> <span style=color:#900;font-weight:700>SimpleWidgetDataTemplateSelector(node)</span>
    <span style=color:#900;font-weight:700>target.GroupHeaderTemplate</span> <span style=color:#900;font-weight:700>&lt;-</span> <span style=color:#900;font-weight:700>GroupedWidgetDataTemplateSelector(node,</span> <span style=color:#900;font-weight:700>Header)</span>
    <span style=color:#900;font-weight:700>target.GroupFooterTemplate</span> <span style=color:#900;font-weight:700>&lt;-</span> <span style=color:#900;font-weight:700>GroupedWidgetDataTemplateSelector(node,</span> <span style=color:#900;font-weight:700>Footer)</span>
    <span style=color:#900;font-weight:700>target.IsGrouped</span> <span style=color:#900;font-weight:700>&lt;-</span> <span style=color:#000;font-weight:700>true
</span><span style=color:#000;font-weight:700></span><span style=color:#900;font-weight:700>)</span>
</code></pre></div><div class="page-footer-meta d-flex flex-column flex-md-row justify-content-between"></div><div class="docs-navigation d-flex justify-content-between"><a class=ms-auto href=https://timothelariviere.com/Fabulous-new/docs/prologue/introduction/><div class="card my-1"><div class="card-body py-2">Introduction &rarr;</div></div></a></div></main></div></div></div><footer class="footer text-muted"><div class=container-xxl><div class=row><div class="col-lg-8 order-last order-lg-first"><ul class=list-inline><li class=list-inline-item>Powered by <a class=text-muted href=https://www.netlify.com/>Netlify</a>, <a class=text-muted href=https://gohugo.io/>Hugo</a>, and <a class=text-muted href=https://getdoks.org/>Doks</a></li></ul></div><div class="col-lg-8 order-first order-lg-last text-lg-end"><ul class=list-inline></ul></div></div></div></footer><script src=https://timothelariviere.com/Fabulous-new/js/bootstrap.min.fdbe9b9ba88a036135318f3c721784d684ac9e3280fe282cc80d7d49f7f9c82780cd54228c1608685a230c09984300d7946fc471734d566fcebc148b65bd16db.js integrity="sha512-/b6bm6iKA2E1MY88cheE1oSsnjKA/igsyA19Sff5yCeAzVQijBYIaFojDAmYQwDXlG/EcXNNVm/OvBSLZb0W2w==" crossorigin=anonymous defer></script>
<script src=https://timothelariviere.com/Fabulous-new/js/highlight.min.2bffd851168ecbbf28174aa9c2250a9f4f720f8e3b4d83c7d3fead6b626f041aca6675601c165b6f05db01e49a8bb5e5dee21006f8ef0dd710831f3210620c1a.js integrity="sha512-K//YURaOy78oF0qpwiUKn09yD447TYPH0/6ta2JvBBrKZnVgHBZbbwXbAeSai7Xl3uIQBvjvDdcQgx8yEGIMGg==" crossorigin=anonymous defer></script>
<script src=https://timothelariviere.com/Fabulous-new/main.min.6bcd117899ffc9e0f284a6a38e48794689fd80fbd8a0a50a6c886e47e1bfac6c90f39ecad7cdc1a52f577e7c99ed379a3b3b84adb674a5776d815dd650d71eb6.js integrity="sha512-a80ReJn/yeDyhKajjkh5Ron9gPvYoKUKbIhuR+G/rGyQ857K183BpS9XfnyZ7TeaOzuErbZ0pXdtgV3WUNcetg==" crossorigin=anonymous defer></script>
<script src=https://timothelariviere.com/Fabulous-new/index.min.5545f352a3795d5d044e8bb50a80ee11be92d9450d237d2878562472e9a77df9ca209fb581c267f03ffa44fddf3d3eaf8c72c315660d3fa945df0b785a2acd55.js integrity="sha512-VUXzUqN5XV0ETou1CoDuEb6S2UUNI30oeFYkcumnffnKIJ+1gcJn8D/6RP3fPT6vjHLDFWYNP6lF3wt4WirNVQ==" crossorigin=anonymous defer></script></body></html>